{
    "name": "Jarvis Finanzas V5 (Fixed Connections)",
    "nodes": [
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "mode": "list",
                    "value": "gpt-4o-mini"
                },
                "builtInTools": {},
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.3,
            "position": [
                -560,
                640
            ],
            "id": "cbbc94db-ffdc-45d7-ae47-a15e758d1871",
            "name": "OpenAI Chat Model",
            "credentials": {
                "openAiApi": {
                    "id": "kzsagMP6DxHMcdAf",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.userPrompt || $json.ai }}",
                "options": {
                    "systemMessage": "=Eres un asistente financiero personal en Colombia üá®üá¥.\nIdioma: ESPA√ëOL (Colombiano).\nPersonalidad: Amigable, usa emojis ü§©.\nOBJETIVOS:\n- Transacciones (Gastos/Ingresos).\n- Presupuestos (Crear/Editar/Borrar).\n- Borrar √∫ltima transacci√≥n.\n- Chat.\nOUTPUT JSON OBLIGATORIO:\n1. PRESUPUESTOS (Budgets):\n- Crear: tipo budget_create, categor√≠a Comida, monto 500000, mensaje \"‚úÖ Presupuesto creado.\"\n- Editar: tipo budget_update, categor√≠a Comida, monto 600000, mensaje \"‚úÖ Presupuesto actualizado.\"\n- Borrar: tipo budget_delete, categor√≠a Comida, mensaje \"üóëÔ∏è Presupuesto borrado.\"\n2. TRANSACCIONES:\n- Gasto: tipo expense, monto 20000, categor√≠a Comida, descripci√≥n Pizza, mensaje \"‚úÖ Anotado!\"\n- Ingreso (Ingressos/Ganhei): tipo income, monto 50000, categor√≠a Salario, descripci√≥n Sueldo, mensaje \"üí∞ Dinero extra!\"\n- Borrar √öltima: tipo transaction_delete_last, mensaje \"üóëÔ∏è Borrando √∫ltima transacci√≥n.\"\n3. Se o usu√°rio quiser mudar/alterar una transa√ß√£o anterior, use type: 'transaction_update_last' e envie os novos dados\n4. CHAT:\n- tipo chat, mensaje \"Hola! üëã\"\n\n‚ö†Ô∏è IMPORTANTE: As chaves do JSON devem ser SEMPRE em ingl√™s: type, amount, category, description, message. NUNCA traduza as chaves para tipo ou mensaje.\n\nOBJETIVO: Clasificar la intenci√≥n del usuario y extraer datos con precisi√≥n.\n\nMODO 1: TRANSACCI√ìN\n- Si el usuario menciona dinero entrando (gan√©, me pagaron, recib√≠, salario): type = 'income'.\n- Si el usuario menciona gastos (gaste, compr√©, pagu√©, se me fueron): type = 'expense'.\n- Si no se especifica categor√≠a, usa 'General' (NUNCA inventes 'Comida' si no se menciona).\n- Reconoce 'mil' como 000 (ej: 200 mil = 200000).\nMODO 2: AN√ÅLISIS\n- Si pregunta 'como voy', 'saldo', 'resumen':\n- Retorna SOLAMENTE: { \"type\": \"analysis\", \"description\": \"analysis_request\" }\nSALIDA JSON:\n{ \"amount\": number, \"category\": \"string\", \"description\": \"string\", \"type\": \"expense/income\" }\n\n",
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 3.1,
            "position": [
                -560,
                416
            ],
            "id": "82e5f78d-7ba8-461f-adbd-ce9cf9b0e336",
            "name": "AI Agent"
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $json.wa_id }}",
                "tableName": "finanzas_n8n_chat_histories"
            },
            "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
            "typeVersion": 1.3,
            "position": [
                -432,
                672
            ],
            "id": "6b576bc7-ad9a-4118-bdc3-d347de2797d0",
            "name": "Postgres Chat Memory",
            "credentials": {
                "postgres": {
                    "id": "5uy59j8UwRyaeB9l",
                    "name": "Postgres Nanos Burguer"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://agente-financeiro:8000/transactions/",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "category",
                            "value": "={{ $json.category }}"
                        },
                        {
                            "name": "type",
                            "value": "={{ $json.type }}"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        },
                        {
                            "name": "amount",
                            "value": "={{ $json.amount }}"
                        },
                        {
                            "name": "description",
                            "value": "={{ $json.description }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                240,
                32
            ],
            "id": "95104be5-49cb-4a3f-8370-d9465026c4a6",
            "name": "Cadastrar"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "413fff19",
                            "name": "type",
                            "value": "={{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).type }}",
                            "type": "string"
                        },
                        {
                            "id": "1c7670b3",
                            "name": "amount",
                            "value": "={{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).amount }}",
                            "type": "string"
                        },
                        {
                            "id": "71ae6055",
                            "name": "category",
                            "value": "={{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).category }}",
                            "type": "string"
                        },
                        {
                            "id": "b9a8ab4d",
                            "name": "message",
                            "value": "={{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).message }}",
                            "type": "string"
                        },
                        {
                            "id": "fb528ca5",
                            "name": "description",
                            "value": "={{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).description }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -208,
                416
            ],
            "id": "db556336-0d63-4e7f-bbc7-e3cd4b0bd56a",
            "name": "Edit Fields2"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "(expense|income)",
                                        "operator": {
                                            "type": "string",
                                            "operation": "regex"
                                        },
                                        "id": "c1e58c7b"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "cadastrar"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "658fe3f3",
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "transaction_delete_last",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "apaga √∫tlima compra"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "0b730897",
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "DISABLED_budget_create",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Cria novo or√ßamento"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "a234a4c9",
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "budget_update|budget_delete|budget_create",
                                        "operator": {
                                            "type": "string",
                                            "operation": "regex"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "Edita/Apaga or√ßamentos"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "24036fb9",
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "chat",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "S√≥ conversa"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 3
                                },
                                "conditions": [
                                    {
                                        "id": "b77ebe8f",
                                        "leftValue": "={{ $json.type }}",
                                        "rightValue": "transaction_update_last",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            }
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.4,
            "position": [
                -64,
                368
            ],
            "id": "270230dc-516d-4388-99b4-69038a6f48ff",
            "name": "Switch",
            "alwaysOutputData": false
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "={{ $json.message }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                256,
                736
            ],
            "id": "da475e7f-207c-4888-a69c-09e2d486672c",
            "name": "Send message",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "url": "http://agente-financeiro:8000/transactions/?limit=1",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "description",
                            "value": "={{ JSON.parse($json.output).description }}"
                        },
                        {
                            "name": "amount",
                            "value": "={{ JSON.parse($json.output).amount }}"
                        },
                        {
                            "name": "category",
                            "value": "={{ JSON.parse($json.output).category }}"
                        },
                        {
                            "name": "type",
                            "value": "={{ JSON.parse($json.output).type || 'expense' }}"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                240,
                224
            ],
            "id": "14bfb7d3-9796-4740-acb3-4679a0828828",
            "name": "buscar √∫ltimo"
        },
        {
            "parameters": {
                "method": "DELETE",
                "url": "=http://agente-financeiro:8000/budgets/{{ $json.id }}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                944,
                528
            ],
            "id": "4f2ee635-95b7-48d2-ac17-36187668d97a",
            "name": "apagar"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "=üóëÔ∏è *Pronto! Apaguei a √∫ltima transa√ß√£o:*\n\nüìù Item: {{ $('buscar √∫ltimo').item.json.description }}\nüí∞ Valor: ${{ $('buscar √∫ltimo').item.json.amount }}\nüìÇ Categoria: {{ $('buscar √∫ltimo').item.json.category }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                1184,
                528
            ],
            "id": "27b5bd79-2779-4398-b3c0-98a68f4654df",
            "name": "Send message1",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "method": "={{ $json.id === 'NEW' ? 'POST' : 'PUT' }}",
                "url": "=http://agente-financeiro:8000/budgets/{{ $json.id === 'NEW' ? '' : $json.id }}",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "limit_amount",
                            "value": "={{ $json.new_limit }}\n"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        },
                        {
                            "name": "category",
                            "value": "={{ $('Edit Fields2').first().json.category }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                960,
                704
            ],
            "id": "2efd56d4-d0ca-4055-9b1b-68cab4358138",
            "name": "criar/editar or√ßamento"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
                "textBody": "= {{ $('Edit Fields2').first().json.message }}\n\nüìÇ Categoria: {{ $json.category }}\nüéØ Limite: ${{ $json.limit_amount }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                1200,
                704
            ],
            "id": "61a92557-2e17-49e7-ba99-1f12765d6a8e",
            "name": "Send message2",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "url": "http://agente-financeiro:8000/budgets/",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "description",
                            "value": "={{ JSON.parse($json.output).description }}"
                        },
                        {
                            "name": "amount",
                            "value": "={{ JSON.parse($json.output).amount }}"
                        },
                        {
                            "name": "category",
                            "value": "={{ JSON.parse($json.output).category }}"
                        },
                        {
                            "name": "type",
                            "value": "={{ JSON.parse($json.output).type || 'expense' }}"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                320,
                576
            ],
            "id": "cb09b7a8-8c38-4892-b284-7eedc902b357",
            "name": "Listar Budgets"
        },
        {
            "parameters": {
                "jsCode": "const aiOutput = $('Edit Fields2').first().json; \nconst targetCategory = aiOutput.category.toLowerCase();\nconst budgets = items.map(item => item.json);\nconst match = budgets.find(b => b.category.toLowerCase() === targetCategory);\n\nif (match) {\n  return [{\n    json: {\n      id: match.id,\n      new_limit: aiOutput.amount,\n      action: aiOutput.type\n    }\n  }];\n}\n\nif (aiOutput.type === 'budget_create') {\n  return [{\n    json: {\n      id: 'NEW',\n      new_limit: aiOutput.amount,\n      action: aiOutput.type\n    }\n  }];\n}\n\nthrow new Error(`N√£o encontrei nenhum or√ßamento para a categoria: ${targetCategory}`);"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                480,
                592
            ],
            "id": "1102cbea-b891-42de-9c91-59c39a7c272d",
            "name": "Achar ID"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 3
                    },
                    "conditions": [
                        {
                            "id": "332cb458",
                            "leftValue": "={{ $('AI Agent').first().item.json.output }}",
                            "rightValue": "budget_update|budget_create",
                            "operator": {
                                "type": "string",
                                "operation": "regex"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.3,
            "position": [
                704,
                592
            ],
            "id": "96e1fff3-cd1f-464f-bfc0-25da00081e9d",
            "name": "Editar ou Apagar?"
        },
        {
            "parameters": {
                "method": "DELETE",
                "url": "=http://agente-financeiro:8000/transactions/{{ $json.id }}",
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                464,
                224
            ],
            "id": "fd3ec8a2-fa42-484d-8103-4690dc0d626c",
            "name": "Deletar Transa√ß√£o"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "=üóëÔ∏è Transa√ß√£o apagada: {{ $('buscar √∫ltimo').first().json.description }}\nüí∞ Valor: {{ $('buscar √∫ltimo').item.json.amount }}\nüìÇ Categoria: {{ $('buscar √∫ltimo').item.json.category }}\n",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                688,
                224
            ],
            "id": "c6c4d09c-4e47-4bbe-8281-f81c1ac61bd4",
            "name": "Send message3",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://agente-financeiro:8000/budgets/",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "category",
                            "value": "={{ $json.category }}"
                        },
                        {
                            "name": "limit_amount",
                            "value": "={{ $json.amount }}"
                        },
                        {
                            "name": "category",
                            "value": "={{ $json.category }}"
                        },
                        {
                            "name": "type",
                            "value": "={{ $json.type }}"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                352,
                416
            ],
            "id": "5d62db3e-086c-4902-890e-ff64a4af80f6",
            "name": "Criar Budget"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
                "textBody": "={{ $('Edit Fields2').first().json.message }}\nValor: {{ $json.limit_amount }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                608,
                416
            ],
            "id": "bb09b582-1829-4c91-aa2a-574f0a52fde6",
            "name": "Send message4",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "url": "http://agente-financeiro:8000/transactions/?limit=1",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "description",
                            "value": "={{ JSON.parse($json.output).description }}"
                        },
                        {
                            "name": "amount",
                            "value": "={{ JSON.parse($json.output).amount }}"
                        },
                        {
                            "name": "category",
                            "value": "={{ JSON.parse($json.output).category }}"
                        },
                        {
                            "name": "type",
                            "value": "={{ JSON.parse($json.output).type || 'expense' }}"
                        },
                        {
                            "name": "date",
                            "value": "={{ $today.format('yyyy-MM-dd') }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                256,
                928
            ],
            "id": "c951587d-9e32-4d16-9f17-55b28a4bd7ef",
            "name": "buscar √∫ltimo1"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.contacts[0].wa_id }}",
                "textBody": "= {{ $('Edit Fields2').first().json.message }}\n\nüìÇ Descrici√≥n: {{ $json.description }}\nüéØ Valor: ${{ $json.amount }}",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                752,
                928
            ],
            "id": "345c5ec3-997e-420a-ab08-0fe1a7ef7945",
            "name": "Send message5",
            "webhookId": "59093ce4-bf5c-438f-a5b8-a92231a64be9",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "method": "PUT",
                "url": "=http://agente-financeiro:8000/transactions/{{ $json.id }}",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "amount",
                            "value": "={{ $('Edit Fields2').first().json.amount }}\n"
                        },
                        {
                            "name": "category",
                            "value": "={{ $('Edit Fields2').first().json.category }}"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                496,
                928
            ],
            "id": "0be31246-d34e-46ad-b8b8-422f12025c93",
            "name": "Atualizar Transa√ß√£o"
        },
        {
            "parameters": {
                "toolDescription": "Eres un Consultor Financiero Colombiano, amigo y directo.\n\nTU TAREA: Reportar los datos EXACTOS que recibes del sistema. NO inventes n√∫meros.\n\nDATOS DEL SISTEMA (JSON):\n{{ JSON.stringify($json) }}\\n\\nINSTRUCCIONES:\n1. Di el 'balance' actual como Saldo Disponible.\n2. Di el total de 'income' e 'expenses' exactos como aparecen en los datos.\n3. Si el usuario pidi√≥ 'saldo', dalo directo.\n4. Revisa 'budgets': Si 'alert' es true, avisa con ‚ö†Ô∏è.\n5. S√© breve.",
                "text": "={{ $json.userPrompt }}",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.agentTool",
            "typeVersion": 3,
            "position": [
                -240,
                720
            ],
            "id": "2bd9e057-34e4-41ef-a6f5-0be89cf18a6b",
            "name": "AI Agent Tool"
        },
        {
            "parameters": {
                "operation": "send",
                "phoneNumberId": "914691621734879",
                "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
                "textBody": "=‚úÖ *{{ $('Edit Fields2').item.json.type == 'income' ? 'Ingreso' : 'Gasto' }} Registrado!*\n\nüìù {{ $('Edit Fields2').item.json.description }}\nüí∞ ${{ $('Edit Fields2').item.json.amount }}\nüìÇ {{ $('Edit Fields2').item.json.category }}\n\n",
                "additionalFields": {}
            },
            "type": "n8n-nodes-base.whatsApp",
            "typeVersion": 1.1,
            "position": [
                496,
                32
            ],
            "id": "b2276403-c405-4723-8e8c-06005c5a3f2a",
            "name": "Mensagem de confirma√ß√£o do cadastro1",
            "webhookId": "e461be41-37b4-41f7-a7e4-78d895161a34",
            "credentials": {
                "whatsAppApi": {
                    "id": "Jl5aH7LJ3O7m8M3p",
                    "name": "WhatsApp account"
                }
            }
        },
        {
            "parameters": {
                "updates": [
                    "messages"
                ],
                "options": {}
            },
            "type": "n8n-nodes-base.whatsAppTrigger",
            "typeVersion": 1,
            "position": [
                -3008,
                416
            ],
            "id": "9fe28947-cb5a-4cd0-b7a5-7a3b13c1e8bf",
            "name": "WhatsApp Trigger",
            "credentials": {
                "whatsAppTriggerApi": {
                    "id": "15oO7pyib9J95bKc",
                    "name": "WhatsApp OAuth account"
                }
            }
        },
        {
            "parameters": {
                "mode": "raw",
                "jsonOutput": "={\n  \"userPrompt\": \"{{ $('WhatsApp Trigger').item.json.messages[0].text.body }}\",\n  \"type\": \"text-message\",\n  \"ai\": \"\",\n  \"name\": {{ $('WhatsApp Trigger').item.json.contacts[0].profile.name }},\n  \"wa_id\": {{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}\n}\n",
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -1008,
                128
            ],
            "id": "a9659975-617d-4e4e-8838-35fbd931d1c9",
            "name": "Extraer informaci√≥n de persona4"
        }
    ],
    "connections": {
        "AI Agent": {
            "main": [
                [
                    {
                        "node": "Edit Fields2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Edit Fields2": {
            "main": [
                [
                    {
                        "node": "Switch",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch": {
            "main": [
                [
                    {
                        "node": "Cadastrar",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "buscar √∫ltimo",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Criar Budget",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Listar Budgets",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Send message",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "buscar √∫ltimo1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Cadastrar": {
            "main": [
                [
                    {
                        "node": "Mensagem de confirma√ß√£o do cadastro1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "buscar √∫ltimo": {
            "main": [
                [
                    {
                        "node": "Deletar Transa√ß√£o",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Deletar Transa√ß√£o": {
            "main": [
                [
                    {
                        "node": "Send message3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Criar Budget": {
            "main": [
                [
                    {
                        "node": "Send message4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Listar Budgets": {
            "main": [
                [
                    {
                        "node": "Achar ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Achar ID": {
            "main": [
                [
                    {
                        "node": "Editar ou Apagar?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Editar ou Apagar?": {
            "main": [
                [
                    {
                        "node": "criar/editar or√ßamento",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "apagar",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "criar/editar or√ßamento": {
            "main": [
                [
                    {
                        "node": "Send message2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "apagar": {
            "main": [
                [
                    {
                        "node": "Send message1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "buscar √∫ltimo1": {
            "main": [
                [
                    {
                        "node": "Atualizar Transa√ß√£o",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Atualizar Transa√ß√£o": {
            "main": [
                [
                    {
                        "node": "Send message5",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "WhatsApp Trigger": {
            "main": [
                [
                    {
                        "node": "Edit Fields",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}