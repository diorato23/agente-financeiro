<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Simplificadas</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="app-container">
        <!-- Overlay -->
        <div class="menu-overlay" id="menuOverlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <i data-lucide="wallet"></i>
                <span>Finanzas</span>
            </div>
            <nav>
                <a href="#" class="active" onclick="switchTab('dashboard')"><i data-lucide="layout-dashboard"></i>
                    Dashboard</a>
                <a href="#" onclick="switchTab('transactions')"><i data-lucide="list"></i> Transacciones</a>
                <a href="#" onclick="switchTab('reports')"><i data-lucide="bar-chart-2"></i> Informes</a>
                <a href="#" onclick="switchTab('budgets')"><i data-lucide="pie-chart"></i> Presupuestos</a>
                <a href="#" onclick="openCategoryModal()"><i data-lucide="tag"></i> Categorías</a>
                <a href="admin.html" id="adminLink" style="display: none;"><i data-lucide="users"></i> Usuarios</a>
            </nav>
            <div style="margin-top: auto; padding: 1rem;">
                <button class="btn-secondary" onclick="logout()" style="width: 100%;">
                    <i data-lucide="log-out" style="width: 18px;"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button id="menuToggle" onclick="toggleSidebar()" style="display: none;">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 id="userNameDisplay" onclick="openProfileModal()"
                        style="cursor: pointer; text-decoration: underline; text-decoration-style: dotted;">Hola,
                        Usuario
                    </h1>
                </div>
                <button class="btn-primary" onclick="openTransactionModal()">
                    <i data-lucide="plus"></i> <span class="btn-text">Nueva Transacción</span>
                </button>
            </header>

            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="summary-cards">
                    <div class="card">
                        <h3>Saldo Total</h3>
                        <p class="amount" id="balanceDisplay">$0 COP</p>
                    </div>
                    <div class="card">
                        <h3>Ingresos</h3>
                        <p class="amount income" id="incomeDisplay">$0 COP</p>
                    </div>
                    <div class="card">
                        <h3>Gastos</h3>
                        <p class="amount expense" id="expenseDisplay">$0 COP</p>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="card chart-card">
                        <h3>Gastos por Categoría</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="card list-card">
                        <h3>Alertas de Presupuesto</h3>
                        <div id="budgetAlerts" class="budget-list">
                            <!-- Budget items injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions" class="view" style="display: none;">
                <div class="mobile-header-nav">
                    <button class="btn-back" onclick="switchTab('dashboard')">
                        <i data-lucide="arrow-left"></i> Volver al Inicio
                    </button>
                </div>

                <!-- Filtros Avançados -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="filter" style="width: 20px;"></i>
                        Filtros de Búsqueda
                    </h3>
                    <form id="filterForm"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Fecha Inicio</label>
                            <input type="date" id="filterDataInicio" style="padding: 0.5rem;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Fecha Fin</label>
                            <input type="date" id="filterDataFim" style="padding: 0.5rem;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Tipo</label>
                            <select id="filterTipo" style="padding: 0.5rem;">
                                <option value="">Todos</option>
                                <option value="income">Ingreso</option>
                                <option value="expense">Gasto</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Categoría</label>
                            <select id="filterCategoria" style="padding: 0.5rem;">
                                <option value="">Todas</option>
                                <!-- Options injected dynamically -->
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Buscar</label>
                            <input type="text" id="filterBusca" placeholder="Descripción..." style="padding: 0.5rem;">
                        </div>
                        <div class="form-group" style="margin: 0; display: flex; align-items: flex-end; gap: 0.5rem;">
                            <button type="button" class="btn-primary" onclick="applyFilters()" style="flex: 1;">
                                <i data-lucide="search" style="width: 16px;"></i> Buscar
                            </button>
                            <button type="button" class="btn-secondary" onclick="clearFilters()">
                                <i data-lucide="x" style="width: 16px;"></i>
                            </button>
                        </div>
                    </form>
                    <div id="filterIndicators" style="margin-top: 1rem; display: none;">
                        <!-- Filter badges will be shown here -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Historial de Transacciones</h3>
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripción</th>
                                <th>Categoría</th>
                                <th>Monto</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList">
                            <!-- Transactions injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports" class="view" style="display: none;">
                <div class="mobile-header-nav">
                    <button class="btn-back" onclick="switchTab('dashboard')">
                        <i data-lucide="arrow-left"></i> Volver al Inicio
                    </button>
                </div>

                <!-- Seletor de Período -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Período del Informe</h3>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Fecha Inicio</label>
                            <input type="date" id="reportDataInicio" style="padding: 0.5rem;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Fecha Fin</label>
                            <input type="date" id="reportDataFim" style="padding: 0.5rem;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.85rem;">Agrupar por</label>
                            <select id="reportAgrupar" style="padding: 0.5rem;">
                                <option value="day">Día</option>
                                <option value="week">Semana</option>
                                <option value="month" selected>Mes</option>
                            </select>
                        </div>
                        <button type="button" class="btn-primary" onclick="generateReport()">
                            <i data-lucide="file-text" style="width: 16px;"></i> Generar Informe
                        </button>
                    </div>
                </div>

                <!-- Cards de Estatísticas -->
                <div class="summary-cards" id="reportStatsCards" style="display: none;">
                    <div class="card">
                        <h3>Total Ingresos</h3>
                        <p class="amount income" id="reportTotalReceitas">$0 COP</p>
                    </div>
                    <div class="card">
                        <h3>Total Gastos</h3>
                        <p class="amount expense" id="reportTotalDespesas">$0 COP</p>
                    </div>
                    <div class="card">
                        <h3>Saldo</h3>
                        <p class="amount" id="reportSaldo">$0 COP</p>
                    </div>
                    <div class="card">
                        <h3>Transacciones</h3>
                        <p class="amount" id="reportQuantidade" style="color: var(--primary);">0</p>
                    </div>
                </div>

                <!-- Gráfico de Evolução -->
                <div class="card" id="reportChartCard" style="display: none; margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Evolución Temporal</h3>
                        <button class="btn-secondary" onclick="exportToCSV()">
                            <i data-lucide="download" style="width: 16px;"></i> Exportar CSV
                        </button>
                    </div>
                    <div style="position: relative; height: 350px;">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>

                <!-- Top Categorias -->
                <div class="charts-container" id="reportTopCategories" style="display: none; margin-top: 1.5rem;">
                    <div class="card">
                        <h3>Top Categorías - Gastos</h3>
                        <div id="topCategoriasDespesas" style="margin-top: 1rem;">
                            <!-- Injected dynamically -->
                        </div>
                    </div>
                    <div class="card">
                        <h3>Top Categorías - Ingresos</h3>
                        <div id="topCategoriasReceitas" style="margin-top: 1rem;">
                            <!-- Injected dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budgets View -->
            <div id="budgets" class="view" style="display: none;">
                <div class="mobile-header-nav">
                    <button class="btn-back" onclick="switchTab('dashboard')">
                        <i data-lucide="arrow-left"></i> Volver al Inicio
                    </button>
                </div>
                <header style="margin-bottom: 20px; justify-content: space-between; display: flex;">
                    <h3>Gestión de Presupuestos</h3>
                    <!-- 'Definir Presupuesto' button now styled as secondary/pill -->
                    <button class="btn-secondary" onclick="openBudgetModal()">
                        <i data-lucide="plus-circle" style="width:18px; margin-right:5px;"></i> <span
                            class="btn-text">Nuevo / Editar
                            Presupuesto</span>
                    </button>
                </header>
                <div class="budget-grid" id="budgetMgmtGrid">
                    <!-- Management Cards injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Transaction Modal (Add/Edit) -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transactionModal')"
                style="float:right; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2 id="transModalTitle" style="margin-bottom: 1.5rem;">Nueva Transacción</h2>
            <form id="transactionForm">
                <input type="hidden" id="transId">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="type" required>
                        <option value="expense">Gasto</option>
                        <option value="income">Ingreso</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto (COP)</label>
                    <input type="text" id="amount" required placeholder="0,00" oninput="formatAmountInput(this)">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <input type="text" id="description" required placeholder="Ej: Supermercado">
                </div>
                <div class="form-group">
                    <label>Categoría</label>
                    <select id="category" required>
                        <option value="" disabled selected>Seleccione una categoría</option>
                        <!-- Options injected dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="date" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('transactionModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Budget Modal (Simplified: Category, Value, Actions) -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('budgetModal')"
                style="float:right; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2 id="budgetModalTitle" style="margin-bottom: 1.5rem;">Presupuesto</h2>
            <form id="budgetForm">
                <input type="hidden" id="budgetId">
                <div class="form-group">
                    <label>Categoría</label>
                    <select id="budgetCategory" required>
                        <option value="" disabled selected>Seleccione una categoría</option>
                        <!-- Options injected dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Límite (COP)</label>
                    <input type="text" id="budgetLimit" required placeholder="0,00" oninput="formatAmountInput(this)">
                </div>

                <div class="modal-actions" style="justify-content: space-between; margin-top: 2rem;">
                    <!-- Delete Button (Only shown if editing) -->
                    <button type="button" id="btnDeleteBudget" class="btn-secondary"
                        style="color: var(--danger); border-color: var(--danger); display:none;"
                        onclick="deleteBudgetAction()">Excluir</button>

                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn-secondary"
                            onclick="closeModal('budgetModal')">Cancelar</button>
                        <!-- 'Incluir' / 'Alterar' changes based on context -->
                        <button type="submit" id="btnSaveBudget" class="btn-primary">Incluir</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')"
                style="float:right; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2 style="margin-bottom: 1.5rem;">Editar Perfil</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label>Su Nombre</label>
                    <input type="text" id="profileName" required placeholder="Ej: Juan Perez">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('profileModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('categoryModal')"
                style="float:right; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2 style="margin-bottom: 1.5rem;">Gestión de Categorías</h2>

            <div style="margin-bottom: 1.5rem;">
                <ul id="categoryList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;">
                    <!-- Categories injected here -->
                </ul>
                <p id="noCategoriesMsg" style="text-align: center; color: var(--text-muted); display: none;">No hay
                    categorías personalizadas.</p>
            </div>

            <form id="categoryForm" style="border-top: 1px solid var(--border); padding-top: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">Nueva
                    Categoría</label>
                <div class="form-group" style="display: flex; gap: 0.5rem;">
                    <input type="text" id="newCategoryName" required placeholder="Ej: Viajes" style="flex:1;">
                    <button type="submit" class="btn-primary" style="width: auto; padding: 0 1rem;">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>